<!-- index.html -->
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mood Board</title>

<!-- PWA / iOS -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1115">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#222733; --text:#e5e7eb; --sub:#b9c0d0;
    --accent:#3b82f6; --accent-2:#22c55e; --line:#2a3040;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,sans-serif; margin:0}
  .wrap{max-width:820px; margin:24px auto; padding:0 16px}
  h1{font-size:1.5rem; margin:0 0 12px}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px}
  #buttons{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  #buttons button{
    background:var(--muted); color:var(--text); border:1px solid var(--line);
    padding:10px 12px; border-radius:10px; cursor:pointer
  }
  #buttons button.active{outline:2px solid var(--accent)}
  .bar{display:flex; gap:8px; margin-top:10px}
  .bar input{flex:1; background:#0c0f15; border:1px solid var(--line); color:var(--text); padding:10px; border-radius:10px}
  .bar button{
    flex:0 0 auto; padding:0 12px; height:40px; border-radius:10px; cursor:pointer;
    background:var(--muted); color:var(--text); border:1px solid var(--line)
  }
  label{display:block; margin-top:16px; font-weight:600}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  select,input,button{font-size:14px}
  select,input[type="number"]{
    width:100%; padding:10px; border-radius:10px; border:1px solid var(--line);
    background:#0c0f15; color:var(--text)
  }
  #guardar,#downloadCsv{
    width:100%; margin-top:14px; padding:12px; border-radius:10px; cursor:pointer;
    border:1px solid var(--line); background:var(--muted); color:var(--text)
  }
  #guardar:hover{outline:2px solid var(--accent)}
  #downloadCsv:hover{outline:2px solid var(--accent-2)}
  #log{margin-top:20px; border-top:1px solid var(--line); padding-top:12px; font-size:.95em}
  .entry{padding:10px; border:1px solid var(--line); border-radius:10px; background:#0c0f15; margin-bottom:8px}
  .hint{color:var(--sub); font-size:.9em}
</style>
</head>

<body>
<div class="wrap">
  <h1>Mood Board</h1>
  <div class="panel">
    <div id="buttons"></div>

    <div class="bar">
      <input id="newEmotion" placeholder="Agregar emoción personalizada">
      <button id="addEmotion" aria-label="Agregar emoción">+</button>
    </div>

    <label>Intensidad (1–10)</label>
    <div class="row2">
      <input type="number" id="intensidad" min="1" max="10" value="5" inputmode="numeric">
      <div class="hint" style="align-self:center">1=leve · 10=extrema</div>
    </div>

    <label>Disparador</label>
    <div class="row2">
      <select id="disparadorSel"></select>
      <input id="disparadorNuevo" placeholder="Nuevo disparador (solo ‘Otro’)" disabled>
    </div>

    <label>Estrategia</label>
    <div class="row2">
      <select id="afrontamientoSel"></select>
      <input id="afrontamientoNuevo" placeholder="Nueva estrategia (solo ‘Otro’)" disabled>
    </div>

    <button id="guardar">Guardar registro</button>
    <button id="downloadCsv">Descargar CSV</button>

    <div id="log"></div>
  </div>
</div>

<script>
  // Service worker (iOS requiere https y Safari → Añadir a pantalla de inicio)
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

  // Bases
  const defaultEmotions = ['Ira','Ansiedad','Vergüenza','Tristeza','Vacío','Calma'];
  const defaultTriggers  = ['Discusión','Crítica','Soledad','Sobrecarga','Recuerdo','Otro'];
  const defaultCoping    = ['Respiración','Escritura','Pausa sensorial','Contacto social','Actividad física','Música','Otro'];

  // Estado
  let emotions = JSON.parse(localStorage.getItem('emociones')) || defaultEmotions.slice();
  let triggers = JSON.parse(localStorage.getItem('disparadores')) || defaultTriggers.slice();
  let copings  = JSON.parse(localStorage.getItem('afrontamientos')) || defaultCoping.slice();
  let entries  = JSON.parse(localStorage.getItem('registros')) || [];
  let currentEmotion = null;

  // UI refs
  const buttonsWrap = document.getElementById('buttons');
  const newEmotion  = document.getElementById('newEmotion');
  const addEmotion  = document.getElementById('addEmotion');
  const intensidad  = document.getElementById('intensidad');

  const disparadorSel   = document.getElementById('disparadorSel');
  const disparadorNuevo = document.getElementById('disparadorNuevo');
  const afrontSel       = document.getElementById('afrontamientoSel');
  const afrontNuevo     = document.getElementById('afrontamientoNuevo');

  function fillSelect(sel, arr){
    sel.innerHTML='';
    sel.add(new Option('Seleccionar',''));
    arr.forEach(v=> sel.add(new Option(v,v)));
    if(!arr.includes('Otro')) sel.add(new Option('Otro','Otro'));
  }
  function toggleNewInput(sel, input){
    input.disabled = sel.value !== 'Otro';
    if(input.disabled) input.value='';
  }

  function renderButtons(){
    buttonsWrap.innerHTML='';
    emotions.forEach(e=>{
      const b=document.createElement('button');
      b.textContent=e;
      b.onclick=()=>{
        currentEmotion=e;
        document.querySelectorAll('#buttons button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
      };
      buttonsWrap.appendChild(b);
    });
  }
  function renderSelects(){
    fillSelect(disparadorSel, triggers);
    fillSelect(afrontSel, copings);
  }
  disparadorSel.addEventListener('change', ()=>toggleNewInput(disparadorSel, disparadorNuevo));
  afrontSel.addEventListener('change', ()=>toggleNewInput(afrontSel, afrontNuevo));

  addEmotion.onclick=()=>{
    const val = newEmotion.value.trim();
    if(!val) return;
    if(!emotions.includes(val)){
      emotions.push(val);
      localStorage.setItem('emociones', JSON.stringify(emotions));
      renderButtons();
    }
    newEmotion.value='';
  };

  document.getElementById('guardar').onclick=()=>{
    if(!currentEmotion){ alert('Selecciona una emoción.'); return; }
    const inten = +intensidad.value || 5;

    let disparador = disparadorSel.value;
    if(disparador === 'Otro'){
      const nv = disparadorNuevo.value.trim();
      if(!nv){ alert('Escribe el nuevo disparador.'); return; }
      disparador = nv;
      if(!triggers.includes(nv)){
        triggers.push(nv);
        localStorage.setItem('disparadores', JSON.stringify(triggers));
        renderSelects();
      }
    }

    let afront = afrontSel.value;
    if(afront === 'Otro'){
      const nv = afrontNuevo.value.trim();
      if(!nv){ alert('Escribe la nueva estrategia.'); return; }
      afront = nv;
      if(!copings.includes(nv)){
        copings.push(nv);
        localStorage.setItem('afrontamientos', JSON.stringify(copings));
        renderSelects();
      }
    }

    const entry = {
      fecha: new Date().toLocaleString(),
      emocion: currentEmotion,
      intensidad: inten,
      disparador,
      estrategia: afront
    };
    entries.push(entry);
    localStorage.setItem('registros', JSON.stringify(entries));
    resetForm();
    renderLog();
  };

  function resetForm(){
    intensidad.value = 5;
    disparadorSel.value=''; disparadorNuevo.value=''; disparadorNuevo.disabled=true;
    afrontSel.value=''; afrontNuevo.value=''; afrontNuevo.disabled=true;
    currentEmotion=null;
    document.querySelectorAll('#buttons button').forEach(x=>x.classList.remove('active'));
  }

  function renderLog(){
    const div=document.getElementById('log');
    if(entries.length===0){ div.innerHTML='<div class="hint">Sin registros.</div>'; return; }
    div.innerHTML = entries.map(r =>
      `<div class="entry">
        <b>${r.emocion}</b> (${r.intensidad}) — ${r.fecha}<br>
        <span class="hint">Disparador:</span> ${r.disparador || '-'} ·
        <span class="hint">Estrategia:</span> ${r.estrategia || '-'}
      </div>`
    ).join('');
  }

  // CSV + Web Share (iOS compatible)
  function buildCsv(){
    const rows = [['fecha','emocion','intensidad','disparador','estrategia']];
    entries.forEach(r=>rows.push([r.fecha,r.emocion,r.intensidad,r.disparador||'',r.estrategia||'']));
    return rows.map(row => row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  }
  document.getElementById('downloadCsv').onclick=async()=>{
    const csv = buildCsv();
    const file = new File([csv], 'mood_board.csv', {type:'text/csv'});
    if (navigator.share && navigator.canShare?.({files:[file]})) {
      try { await navigator.share({ files:[file], title:'Mood Board' }); return; } catch {}
    }
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mood_board.csv';
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
  };

  renderButtons();
  renderSelects();
  renderLog();
</script>
</body>
</html>
